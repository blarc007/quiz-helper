chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'scan') {
    const questions = [];
    const questionElems = document.querySelectorAll('.que.multichoice');

    questionElems.forEach((qElem) => {
      const questionTextElem = qElem.querySelector('.qtext');
      const questionText = questionTextElem ? questionTextElem.textContent.trim() : '';
      
      const answerDiv = qElem.querySelector('.answer');
      if (answerDiv) {
        const options = answerDiv.querySelectorAll('div[class^="r"]');
        let answerText = '';
        options.forEach((option) => {
          const correctImg = option.querySelector('img[src*="grade_answer"]');
          if (correctImg) {
            const answerContent = option.querySelector('.flex-fill.ml-1')?.textContent.trim() || '';
            answerText = answerContent; // 只儲存答案文字（如 "否"）
          }
        });
        
        if (questionText && answerText) {
          questions.push({ question: questionText, answer: answerText });
        }
      }
    });

    if (questions.length > 0) {
      chrome.storage.local.get('questions', (data) => {
        let stored = data.questions || [];
        const unique = questions.filter(q => !stored.some(s => s.question === q.question));
        stored = [...stored, ...unique];
        chrome.storage.local.set({ questions: stored }, () => {
          sendResponse({ success: true, count: unique.length });
        });
      });
    } else {
      sendResponse({ success: false, message: '未找到題目或答案' });
    }
    return true;
  } else if (request.action === 'hint') {
    chrome.storage.local.get('questions', (data) => {
      const stored = data.questions || [];
      const questionElems = document.querySelectorAll('.que.multichoice');
      let modified = false; // 追蹤是否有選項被修改
      
      questionElems.forEach((qElem) => {
        const questionTextElem = qElem.querySelector('.qtext');
        const questionText = questionTextElem ? questionTextElem.textContent.trim() : '';
        const match = stored.find(s => s.question === questionText);
        
        if (match) {
          const options = qElem.querySelectorAll('.answer div[class^="r"]');
          options.forEach((option) => {
            const optionText = option.querySelector('.ml-1')?.textContent.trim() || '';
            if (optionText === match.answer) {
              // 插入圖標
              const dFlex = option.querySelector('.d-flex.w-100');
              if (dFlex && !dFlex.querySelector('.questioncorrectnessicon')) {
                const img = document.createElement('img');
                img.src = 'https://ilearn.elearning.cht.com.tw/theme/image.php/adaptable/core/1744425936/i/grade_answer';
                img.alt = '';
                img.className = 'questioncorrectnessicon';
                img.style.marginRight = '5px';
                dFlex.insertBefore(img, dFlex.firstChild);
              }
              
              // 選取radio按鈕
              const radio = option.querySelector('input[type="radio"]');
              if (radio && !radio.checked) {
                radio.checked = true; // 設置為選中
                modified = true;
                // 觸發change事件（模擬用戶操作，確保autosave觸發）
                const event = new Event('change', { bubbles: true });
                radio.dispatchEvent(event);
              }
            }
          });
        }
      });
      sendResponse({ 
        success: true, 
        message: modified ? '已標記並選取匹配的答案' : '未找到匹配的題目或已選取' 
      });
    });
    return true;
  }
});